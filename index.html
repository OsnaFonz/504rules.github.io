<html manifest="manifest.appcache">
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="initial-scale=1,user-scalable=yes">
	<title>504</title>
	<script src="js/jquery-1.11.3.min.js"></script>
	<script src="js/template-loader.js"></script>
	<script src="js/mustache.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="css/bootstrap.css">
	<link rel="stylesheet" href="css/bootstrap-theme.min.css">
	<link rel="stylesheet" href="css/main.css" media="all">
	<link rel="apple-touch-icon" href="img/apple-touch-icon-180x180.png"/>
	<style type="text/css"></style>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top" id="menu">
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-8">
				<div class="panel panel-default">
					<div class="panel-heading"><strong data-i18n="select_modules"></strong></div>
					<div class="panel-body">
						<div class="row">
							<div class="col-md-8">
								<div class="btn-group modules" role="group" aria-label="randomizer"><button class="mod1 btn stateon"><img src="img/modules/icon-mod1.png" data-i18n-alt="mod1" data-i18n-title="mod1" /></button><button class="mod2 btn stateon"><img src="img/modules/icon-mod2.png" data-i18n-alt="mod2" data-i18n-title="mod2" /></button><button class="mod3 btn stateon"><img src="img/modules/icon-mod3.png" data-i18n-alt="mod3" data-i18n-title="mod3" /></button><button class="mod4 btn stateon"><img src="img/modules/icon-mod4.png" data-i18n-alt="mod4" data-i18n-title="mod4" /></button><button class="mod5 btn stateon"><img src="img/modules/icon-mod5.png" data-i18n-alt="mod5" data-i18n-title="mod5" /></button><button class="mod6 btn stateon"><img src="img/modules/icon-mod6.png" data-i18n-alt="mod6" data-i18n-title="mod6" /></button><button class="mod7 btn stateon"><img src="img/modules/icon-mod7.png" data-i18n-alt="mod7" data-i18n-title="mod7" /></button><button class="mod8 btn stateon"><img src="img/modules/icon-mod8.png" data-i18n-alt="mod8" data-i18n-title="mod8" /></button><button class="mod9 btn stateon"><img src="img/modules/icon-mod9.png" data-i18n-alt="mod9" data-i18n-title="mod9" /></button>
								</div>
							</div>
							<div class="col-md-4 text-center" style="padding-top:0.5em;">
								<div class="btn-group modules btn-group-lg" role="group" aria-label="randomizer">
									<button class="btn btn-default" type="button" id="selectnone" data-i18n-title="deselect_all"><span class="glyphicon glyphicon-unchecked" style="cursor: pointer;"></span></button> 
									<button class="btn btn-default" type="button" id="selectall" data-i18n-title="select_all"><span class="glyphicon glyphicon-check" style="cursor: pointer;"></span></button>
								</div>
								<div class="btn-group modules btn-group-lg" role="group" aria-label="randomizer">
									<button class="btn btn-default randomizer" type="button" data-i18n-title="randomize"><span class="glyphicon glyphicon-random" style="cursor: pointer;"></span></button> 
								</div>
							</div>
						</div>
					</div>
					<div class="panel-footer">
						<p class="moduleDescription">&nbsp;</p>
					</div>
				</div>				
			</div>
			<div class="col-md-4">
				<div class="panel panel-default">
					<div class="panel-heading"><strong data-i18n="other_options"></strong></div>
					<div class="panel-body">
						<div class="form-horizontal">
							<div class="form-group">
								<div class="col-sm-offset-1 col-sm-11">
									<div class="checkbox">
										<label><input type="checkbox" name="print-privileges" id="print-privileges" value="-1" checked /><span data-i18n="print_privileges"></span> <small data-i18n="yes_no"></small></label>
									</div>				
								</div>				
							</div>				
						</div>				
					</div>
				</div>
			</div>
		</div>
	</div>
</nav>
<div class="container">
	<div id="target-head" data-i18n="loading_head"></div>
	<div id="target-setup" data-i18n="loading_setup"></div>
	<div id="target-privileges" data-i18n="loading_privileges"></div>
	<div id="target-examples" data-i18n="loading_examples"></div>
</div>
<div class="container">
	<div id="target-phase12" data-i18n="loading_phase12"></div>
	<div id="target-phase3abcd" data-i18n="loading_phase3abcd"></div>
	<div id="target-phase3efgh" data-i18n="loading_phase3efgh"></div>
	<div id="target-scoring" data-i18n="loading_scoring"></div>
</div>
<div class="container print-priv">
	<div id="target-privileges-print" data-i18n="loading_privileges_print"></div>
</div>

<div id="templates" style="display:none;"></div>
<script src="js/i18n.js"></script>

<script>


	function explorer_map(maps) {
		for(var i = 0; i < maps.length; i++) {
			if(maps[i].priority == 2 || maps[i].priority == 3) {
				return {'value': 1};
			}
		}
		return {'value': 4};
	}

	function randomizeWorlds () {
		var states = { 'stateon': [], 'stateoff': [], 'statelock':[] };
		var modules = [];
		var premodules = [];
		
		$('.modules').find('button[class^=mod]').each( function () {
			var classes = $(this).attr('class').split(' ');
			states[classes[2]].push(classes[0].substring(3));
		});
		
		$.map(states['statelock'], function(value, key) { modules.push(value);} );
		
		if(modules.length!=3) {
			$.map(states['stateon'], function(value, key) { premodules.push(value);} );
			premodules = shuffle(premodules, 3-modules.length);
		}
		
		modules = shuffle($.merge(modules, premodules), 3);
		update_world(modules[0] + modules[1] + modules[2]);
	}

	function setModuleSelect(newState) {
		$('.modules').find('button[class^=mod]').each( function () {
			$(this).removeClass('stateon').removeClass('statelock').removeClass('stateoff').addClass(newState);
		});
		$('.modules').find('div.locked').remove();
		$('.modules').find('.statelock').append('<div class="locked"><span class="glyphicon glyphicon-lock" aria-hidden="true"></span></div>');
		checkThree($('.modules').find('.statelock').length+$('.modules').find('.stateon').length);
	}
	
	function toggleModuleSelect(module) {
		var classes = $(module).attr('class').split(' ');
		var newState = "";
		var statelock = $('.modules').find('.statelock').length;
		
		switch(classes[2]) {
			case "stateon": newState = statelock<3 ? "statelock":"stateoff"; break;
			case "statelock": newState = "stateoff"; break;
			case "stateoff": newState = "stateon"; break;
			default: newState = "stateon";
		}
		
		$('.modules').find('div.locked').remove();
		$(module).removeClass('stateon').removeClass('statelock').removeClass('stateoff').addClass(newState);
		
		$('.modules').find('.statelock').append('<div class="locked"><span class="glyphicon glyphicon-lock" aria-hidden="true"></span></div>');

		checkThree($('.modules').find('.statelock').length+$('.modules').find('.stateon').length);
		changeModuleDescription(module);
	}
	
	function changeModuleDescription(module) {
		var classes = $(module).attr('class').split(' ');
		var state = "";
		$('.moduleDescription').html($(module).find('img').attr('title')+' ('+states_defs[classes[2]]+')');
	}
	
	function togglePrintPrivileges() {
		if($('#print-privileges').prop( "checked" )) {
			$('.container.print-priv').removeClass('printoff');
		} else {
			$('.container.print-priv').addClass('printoff');
		}
		
	}
	
	function checkThree(value) {
		if(value>=3) {
			$('.randomizer').prop('disabled', false).css("opacity", "1");;
		} else {
			$('.randomizer').prop('disabled', true).css("opacity", "0.2");;
		}
	}
	
	var world;
	var modules;

	var parts = {
		'2': {'name': 'goods', 'max': 48},
		'3': {'name': 'covering tokens', 'max': 30},
		'4': {'name': 'city cards', 'max': 10},
		'5': {'name': 'price token', 'max': 1},
		'6': {'name': 'starting player card', 'max': 1},
		'8': {'name': 'privileges', 'max': 66},
		'10': {'name': 'transport trolleys', 'max': 5},
		'11': {'name': 'cargo hold cards', 'max': 5},
		'12': {'name': 'movement point tokens', 'max': 10},
		'13p': {'id': '13', 'name': 'settlements per player', 'max': 30},
		'13s': {'id': '13', 'name': 'settlements per company', 'max': 15},
		'14p': {'id': '14', 'name': 'residents per player', 'max': 30},
		'14s': {'id': '14', 'name': 'residents per company', 'max': 15},
		'15s': {'id': '15', 'name': 'share value board', 'max': 1},
		'15g': {'id': '15', 'name': 'goods price board', 'max': 1},
		'16': {'name': 'victory point tokens', 'max': 100},
		'17': {'name': 'majority board', 'max': 1},
		'18': {'name': 'marking tokens', 'max': 30},
		'19': {'name': 'factories', 'max': 30},
		'20': {'name': 'turn order cards', 'max': 3},
		'21': {'name': 'dice', 'max': 3},
		'22': {'name': 'militia', 'max': 8},
		'23': {'name': 'barracks', 'max': 8},
		'24': {'name': 'explorer tiles', 'max': 6},
		'25': {'name': 'income tokens', 'max': 30},
		'26': {'name': 'roads', 'max': 90},
		'27': {'name': 'starting cards', 'max': 4},
		'28': {'name': 'scoring cards', 'max': 17},
		'29': {'name': 'plants', 'max': 40},
		'30': {'name': 'stock company boards', 'max': 5},
		'31': {'name': 'share value tokens', 'max': 5},
		'32': {'name': 'shares', 'max': 45},
		'33': {'name': 'overview tile', 'max': 1},
		'36': {'name': 'boat', 'max': 1},
	}
	
	var shares_defs = {
		"company": {agent: 'president', sagent: 'the president', owner: 'company', owners:'companies' , fowns: 'the company\'s', owns: 'its', company: true},
		"player": {agent: 'player', sagent: 'he', owner: 'player', owners:'players',  fowns: 'his', owns: 'his', company: false}
	}
	
	var states_defs = {
		"stateon": "on",
		"stateoff": "off",
		"statelock": "locked"
	}
	
	var privilege_defs = {
		'I': {
			'1': {allow:  ['4.I', '4.II', '5.I', '8.I', '8.II'], disallow: [] },
			'2': {allow: ['2.I', '2.II', '4.II', '6.II', '7.II', '8.II', '9.I', '9.II'], disallow: [] },
			'3': {allow: ['9.I', '9.II'], disallow: [] },
			'4': {allow: ['4.I', '4.II'], disallow: [] },
			'5': {allow: ['2.II', '3.II', '5.II', '8.II', '9.I', '9.II'], disallow: [] },
			'6': {allow: ['1.II'], disallow: [] },
			'7': {allow: ['9.I'], disallow: [] },
			'8': {allow: ['1.I', '1.II'], disallow: [] },
			'9': {allow: ['6.I', '6.II'], disallow: [] },
			'10': {allow: ['5'], disallow: [] },
			'11': {allow: ['all'], disallow: ['9.I'] },
			'12': {allow: ['7.I', '7.II'], disallow: [] },
		},
		'II': {
			'1': {allow: ['9.I'], disallow: [] },
			'2': {allow: ['3.I', '3.II'], disallow: [] },
			'3': {allow: ['3.II'], disallow: [] },
			'4': {allow: ['residents'], disallow: [] },
			'5': {allow: ['1'], disallow: [] },
			'6': {allow: ['8.I', '8.II'], disallow: [] },
			'7': {allow: ['1.I', '1.II', '4.I', '4.II', '6.I', '6.II', '8.I'], disallow: [] },
			'8': {allow: ['6.I', '6.II'], disallow: [] },
			'9': {allow: ['all'], disallow: ['9.I'] },
			'10': {allow: ['7.I', '7.II'], disallow: [] },
			'11': {allow: ['residents'], disallow: [] },
			'12': {allow: ['2.II', '3.II', '5.II', '8.II', '9.I', '9.II'], disallow: [] },
		},
		'III': {
			'1': {allow: ['1.I', '1.II'], disallow: [] },
			'2': {allow: ['7.I', '7.II'], disallow: [] },
			'3': {allow: ['7.I', '7.II'], disallow: [] },
			'4': {allow: ['4.I', '4.II'], disallow: [] },
			'5': {allow: ['4.II'], disallow: [] },
			'6': {allow: ['all'], disallow: ['3.III', '9.I'] },
			'7': {allow: ['3.I'], disallow: [] },
			'8': {allow: ['8.I', '8.II'], disallow: [] },
			'9': {allow: ['6.I', '6.II'], disallow: [] },
		}
			
	}
	
	var module_defs = {
		'1': {
			'name': 'Pick up & Deliver',
			'I': {
				'residents': false,
				'map': {'priority': 3, 'value': 3},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 5, 'fixed': true, 'amount': 60},
				'parts': {'2': 48, '3': 30, '10': 5, '11': 5, '12': 10, '33': 1},
				'before_render': function(params, module) {
					if(!params.residents) {
						if(params.world[1] == '9') {
							module['parts']['13s'] = 15;
						} else {
							module['parts']['13p'] = 20;
						}
					}
				},
			},
			'II': {
				'residents': false,
				'map': {'priority': 3, 'value': 3},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 5, 'fixed': true, 'amount': 60},
				'parts': {'2': 48, '3': 30, '10': 5, '11': 5, '12': 10, '15g': 1, '33': 1},
				'before_render': function(params, module) {
					if(!params.residents) {
						if(params.world[0] == '9') {
							module['parts']['13s'] = 15;
						} else {
							module['parts']['13p'] = 20;
						}
					}
				}
			},
			'III': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'10': 5, '11': 5, '12': 10, '33': 1},
				'before_render': function(params, module) {
					if(!params.residents) {
						if(params.world[0] == '9' || params.world[1] == '9') {
							module['parts']['13s'] = 15;
						} else {
							module['parts']['13p'] = 20;
						}
					}
				}
			},
		},
		'2': {
			'name': 'Race',
			'I': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'4': 10},
				'before_render': function(params, module) {
					if(!params.residents) {
						module['parts']['14p'] = 9;
					}
				},
			},
			'II': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'4': 10},
				'before_render': function(params, module) {
					if(!params.residents) {
						module['parts']['14p'] = 9;
					}
				},
			},
			'III': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'17': 1, '18': 30},
				'before_render': function(params, module) {
					switch(params.world[0]) {
					case '1':
						module['parts']['16'] = 25;
						break;
					case '3':
						module['parts']['16'] = 20;
						break;
					case '4':
						module['parts']['16'] = 52;
						break;
					case '5':
						module['parts']['16'] = 30;
						break;
					case '6':
						module['parts']['16'] = 30;
						break;
					case '7':
						module['parts']['16'] = 30;
						break;
					case '8':
						module['parts']['16'] = 25;
						break;
					}
				},
			},
		},
		'3': {
			'name': 'Privileges',
			'I': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 1, 'income': true},
				'money': {'priority': 2, 'fixed': true, 'amount': 90},
				'parts': {'8': 66, '5': 1, '16': 100, '19': 30, '20': 3},
			},
			'II': {
				'residents': false,
				'map': {'priority': 3, 'value': 3},
				'order': {'priority': 2, 'income': true},
				'money': {'priority': 2, 'fixed': true, 'amount': 90},
				'parts': {'8': 66, '5': 1, '19': 30, '20': 3},
			},
			'III': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 9, 'extra': true, 'amount': 20},
				'parts': {'8': 66, '5': 1},
			},
		},
		'4': {
			'name': 'Military',
			'I': {
				'residents': true,
				'map': {'priority': 2, 'value': 2},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 4, 'fixed': true, 'amount': 80},
				'parts': {'21': 3, '22': 8, '23': 8, '33': 1},
			},
			'II': {
				'residents': true,
				'map': {'priority': 2, 'value': 2},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 5, 'fixed': true, 'amount': 60},
				'parts': {'21': 3, '22': 8, '23': 8, '33': 1},
			},
			'III': {
				'residents': true,
				'map': {'priority': 2, 'value': 2},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 5, 'fixed': true, 'amount': 60},
				'parts': {'21': 3, '22': 8, '23': 8},
			},
		},
		'5': {
			'name': 'Exploring',
			'I': {
				'residents': true,
				'map': {'priority': 1, 'func': explorer_map},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 3, 'increasing': true},
				'parts': {'24': 6, '21': 1, '16': 100},
			},
			'II': {
				'residents': false,
				'map': {'priority': 1, 'value': 1},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 3, 'increasing': true},
				'parts': {'24': 6, '21': 1, '25': 30},
			},
			'III': {
				'residents': false,
				'map': {'priority': 1, 'func': explorer_map},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 3, 'increasing': true},
				'parts': {'24': 6, '21': 1},
			},
		},
		'6': {
			'name': 'Roads',
			'I': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'26': 90, '17': 1, '18': 30, '33': 1},
			},
			'II': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'26': 90, '17': 1, '18': 30, '33': 1},
			},
			'III': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'26': 90, '33': 1},
			},
		},
		'7': {
			'name': 'Majorities',
			'I': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 1, 'vp': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'27': 4, '28': 17, '16': 100, '17': 1, '18': 30},
			},
			'II': {
				'residents': true,
				'map': {'priority': 3, 'value': 3},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 3, 'increasing': true},
				'parts': {'17': 1, '18': 30},
			},
			'III': {
				'residents': false,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'17': 1, '18': 30},
			},
		},
		'8': {
			'name': 'Production',
			'I': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'2': 48, '29': 40, '33': 1},
			},
			'II': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'2': 48, '29': 40, '33': 1},
			},
			'III': {
				'residents': true,
				'map': {'priority': 4, 'value': 5},
				'order': {'priority': 4, 'clockwise': true},
				'money': {'priority': 6, 'increasing': true},
				'parts': {'29': 40, '33': 1},
				'before_render': function(params, module) {
					if(params.world.indexOf('1') != -1) {
						module['parts']['2'] = '48';
					}
				},
			},
		},
		'9': {
			'name': 'Shares',
			'I': {
				'residents': false,
				'map': {'priority': 9, 'value': 0},
				'order': {'priority': 1, 'shares': true},
				'money': {'priority': 1, 'shares': true},
				'parts': {'30': 5, '15s': 1, '31': 5, '32': 45, '20': 3, '6': 1},
			},
			'II': {
				'residents': false,
				'map': {'priority': 9, 'value': 0},
				'order': {'priority': 2, 'shares': true},
				'money': {'priority': 1, 'shares': true},
				'parts': {'30': 5, '15s': 1, '31': 5, '32': 45, '20': 3, '6': 1},
			},
			'III': {
				'residents': false,
				'map': {'priority': 9, 'value': 0},
				'order': {'priority': 3, 'income': true},
				'money': {'priority': 9},
				'parts': {'15s': 1, '31': 5, '32': 45, '20': 3},
			},
		},
	}

	function priority_match(items) {
		var best = items[0];
		for(var i = items.length - 1; i >= 0; i--) {
			if(items[i]['priority'] <= best['priority']) {
				best = items[i];
			}
		}
		if(best['func'] != undefined) {
			return best['func'](items);
		} else {
			return best;
		}
	}
	
	function catchPrivileges(world) {
		var cards = {};
		var worldmapping = [world[0]+".I", world[1]+".II", world[2]+".III"];
		var residents = false;
		var counter = [];
		cards['list'] = [];
		
		if (modules['I']['residents'] || modules['II']['residents'] || modules['III']['residents'] || world.indexOf('1') == -1) residents = true;
		
		$.map(privilege_defs, function(stepcards, step) {
			cards[step] = {};
			counter[step] = 0;
			$.map(stepcards, function(value, key) {
				var cardflag = false;
				$.each(value['allow'], function (alval, alkey) {
					if(worldmapping.indexOf(alkey)!=-1 || alkey=="all" || (alkey=="residents" && residents) || world.indexOf(alkey)!=-1 || world.indexOf(alkey)!=-1) {
						cardflag=true;
					}
				});
				$.each(value['disallow'], function (alval, alkey) {
					if(worldmapping.indexOf(alkey)!=-1 || world.indexOf(alkey)!=-1) cardflag=false;
				});
				
				if(cardflag) {
					cards[step][key] = true;
					cards['list'].push(step+" ("+key+")");
					counter[step] += 1;
				}
			});
			
			if(counter[step] > 0) {
				cards[step]['exists'] = true;
			} else {
				cards[step]['exists'] = false;
			}
		});

		if(cards['list'].length > 0) {
			var lastpriv = cards['list'].pop();
			cards['list'] = cards['list'].join(", ");
			cards['list'] += " and "+lastpriv;
		}
		
		return cards
	}
	
	function validate_world(worldno) {
		var world = worldno.split('');
		if (
			world.length != 3
			|| !world.every(function(x) {return x.length==1 && x > '0' && x <= '9'})
			|| world[0] == world[1] || world[0] == world[2] || world[1] == world[2]) {
			return null;
		} else {
			return world;
		}
	}

	function update_world(worldno) {
		if(validate_world(worldno) != null)
			window.location.hash = "#" + worldno
	}

	function shuffle(arr, num) {
		if(num == undefined) num = arr.length;
		
		for (var i = arr.length - 1; i > 0; i--) {
			var j = Math.floor(Math.random() * (i + 1));
			var temp = arr[i];
			arr[i] = arr[j];
			arr[j] = temp;
		}
		
		arr = arr.slice(0,num);
		return arr;
		
	}
	
	function getNameTokens(world) {
		if(world.indexOf('9') == 1||world.indexOf('9') == 0) {
			return "company";
		}
		return "player";
	}
	
	function buildRules(template) {
		
		var capture_stack = [];
		var params = {
			'capture': function() {
				return function(template, render) {
					var rendered = render(template).trim();
					if(rendered.length > 0)
						capture_stack.push(rendered);
					return '';
				};
			},
			'hascapture': function() {
				return function(template, render) {
					if(capture_stack.length > 0) {
						return render(template);
					} else {
						return '';
					}
				};
			},
			'captured': function() {
				return capture_stack.pop();
			},
			'world': world,
			'module': modules,
			'residents': modules['I']['residents'] || modules['II']['residents'] || modules['III']['residents'] || world.indexOf('1') == -1,
			'hurry': world.indexOf('2') != -1 || world.indexOf('8') != -1,
			'map': priority_match([modules['I']['map'], modules['II']['map'], modules['III']['map']]),
			'mapnum': {},
			'order': priority_match([modules['I']['order'], modules['II']['order'], modules['III']['order']]),
			'money': priority_match([modules['I']['money'], modules['II']['money'], modules['III']['money']]),
			'agent': shares_defs[getNameTokens(world)]['agent'],
			'sagent': shares_defs[getNameTokens(world)]['sagent'],
			'owner':shares_defs[getNameTokens(world)]['owner'],
			'owners':shares_defs[getNameTokens(world)]['owners'],
			'fowns':shares_defs[getNameTokens(world)]['fowns'],
			'owns':shares_defs[getNameTokens(world)]['owns'],
			'company':shares_defs[getNameTokens(world)]['company'],
			'priv': catchPrivileges(world),
		};
	
		params[world[0]] = {'I': true};
		params[world[1]] = {'II': true};
		params[world[2]] = {'III': true};
		params['mapnum'][params.map.value] = true;
		params[world.join('')] = true;

		// Run pre-render hooks and assemble the list of parts
		var game_parts = {};
		$.map(['I', 'II', 'III'], function(i) {
			if(modules[i]['before_render'] != undefined)
				modules[i]['before_render'](params, modules[i]);

			$.map(modules[i]['parts'], function(value, key) {
				game_parts[key] = Math.min(
					(game_parts[key] || 0) + value,
					parts[key]['max']);
			});
		});
		var part_list = [];
		$.map(game_parts, function(value, key) {
			var partinfo = parts[key];
			part_list.push({
				'name': partinfo.name,
				'id': partinfo.id==undefined?key:partinfo.id,
				'count': value,
			});
		});
		part_list.sort(function(a, b) {
			return a['id'] - b['id'];
		});
		params['parts'] = part_list;

		params['long_name'] = Mustache.render($('#name-template').html(), params);
		$("title").text(params['long_name'])

		var rendered = Mustache.render(template, params);

		return rendered;
		
	}
	
	function toggleMenu() {
		if($("#menu").is(':hidden')) {
			$("#menu").slideDown(100, function () {
				$("body").css({ "padding-top": $("nav").outerHeight()+"px" });
			});
		} else {
			$("#menu").slideUp(100);		
			$("body").css({ "padding-top": "0px" });
		}
	}
	
	function load() {
		
		world = validate_world(window.location.hash.substr(1)) || ['1', '2', '3'];
		
		modules = {
			'I': $.extend(true, {}, module_defs[world[0]]['I']),
			'II': $.extend(true, {}, module_defs[world[1]]['II']),
			'III': $.extend(true, {}, module_defs[world[2]]['III']),
		};

		var pageSections = ['head','setup','privileges','examples','phase12','phase3abcd','phase3efgh','scoring'];
		$.each(pageSections, function(index, value) {
			var template = $('#template-' + value).html();
			if (template) {
				$('#target-' + value).html(buildRules(template));
			} else {
				console.error('Template not found for:', value);
			}
		});
		
		var tmp = $('#template-privileges').html();
		tmp = tmp.replace(/ col-xs-12/g, ' col-xs-6');
		
		$('#target-privileges-print').html(buildRules(tmp));
		
		
		$("#worldno").click(function() {
			$("#worldno-entry, #worldno").toggle();

			var entry = $("#worldno-entry");
			if(entry.is(":visible")) {
				entry.val(window.location.hash.substr(1))
					.focus()
					.select();
			} else {
				update_world($("#worldno-entry").val());
			}
		});

		$("#worldno-entry").on("keypress", function(event) {
			if(event.which == 13) {
				update_world($("#worldno-entry").val());
				$("#worldno-entry, #worldno").toggle();
			}
		}).blur(function() {
			update_world($("#worldno-entry").val());
			$("#worldno-entry, #worldno").toggle();
		});
		
		$('#menuToggle').on('click', function (e) { toggleMenu(); });
		$('#printicon').on('click', function (e) { window.print(); });
		$('div.randomizer').on('click', function (e) { randomizeWorlds(); });

	}
	
	$(function() { 
		$('#selectall').on('click', function (e) { setModuleSelect('stateon'); });
		$('#selectnone').on('click', function (e) { setModuleSelect('stateoff'); });
		$('button.randomizer').on('click', function (e) { randomizeWorlds(); });
		$('#print-privileges').on('click', function (e) { togglePrintPrivileges(); });
		
		$('.modules').find('button[class^=mod]').each( function () {
			$(this).on('click', function (e) { toggleModuleSelect(this); });
			$(this).on('mouseover', function (e) { changeModuleDescription(this); });
		});
		
	});

	
	$(document).ready(function() {
		$(document).on('templateLoaderReady', load);
	});
	$(window).bind('hashchange', load);
	$(window).bind('beforeprint', function() { $("#menu").slideUp(0); }); //didn't work in chrome
	
</script>
<script>
	// Via http://stackoverflow.com/questions/12556593/determining-a-page-is-outdated-on-github-pages
	// Check if a new cache is available on page load.

	window.addEventListener('load', function(e) {
		var appCache = window.applicationCache;

		if ( !appCache ) {
			return;
		}

		appCache.addEventListener('updateready', function(e) {
			if (appCache.status === appCache.UPDATEREADY) {
				// Browser downloaded a new app cache.
				// Swap it in and reload the page to get the new hotness.
				appCache.swapCache();
				window.location.reload();
			}
		}, false);
	}, false);


</script>

</body>
</html>
